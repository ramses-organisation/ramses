!#########################################################
!#########################################################
!#########################################################
!#########################################################
subroutine gravana(x, f, dx, ncell)
    use amr_parameters
    use poisson_parameters
    implicit none
    integer :: ncell                         ! Size of input arrays
    real(dp) :: dx                            ! Cell size
    real(dp), dimension(1:nvector, 1:ndim) :: f ! Gravitational acceleration
    real(dp), dimension(1:nvector, 1:ndim) :: x ! Cell center position.
    ! ================================================================
    ! This routine computes the acceleration using analytical models.
    ! x(i,1:ndim) are cell center position in [0,boxlen] (user units).
    ! f(i,1:ndim) is the gravitational acceleration in user units.
    ! ================================================================
    integer :: idim, i
    real(dp) :: gmass, emass, xmass, ymass, zmass, rr, rx, ry, rz
    real(dp) :: cnfw, Mvirphu, rvir, pi
    pi = 3.1415926_dp
    ! Constant vector
    if (gravity_type == 1) then
        do idim = 1, ndim
            do i = 1, ncell
                f(i, idim) = gravity_params(idim)
            end do
        end do
    end if

    ! Point mass
    if (gravity_type == 2) then
        gmass = gravity_params(1) ! GM
        emass = gravity_params(2) ! Softening length
        xmass = gravity_params(3) ! Point mass coordinates
        ymass = gravity_params(4)
        zmass = gravity_params(5)
        do i = 1, ncell
            rx = 0.0d0; ry = 0.0d0; rz = 0.0d0
            rx = x(i, 1) - xmass
#if NDIM > 1
            ry = x(i, 2) - ymass
#endif
#if NDIM > 2
            rz = x(i, 3) - zmass
#endif
            rr = sqrt(rx ** 2 + ry ** 2 + rz ** 2 + emass ** 2)
            f(i, 1) = - gmass * rx / rr ** 3
#if NDIM > 1
            f(i, 2) = - gmass * ry / rr ** 3
#endif
#if NDIM > 2
            f(i, 3) = - gmass * rz / rr ** 3
#endif
        end do
    end if

    ! NFW
    if (gravity_type == 3) then
        cnfw = 6./ (Mvir / 1d14) **.2
        Mvirphu = Mvir * 1.99d33
        rvir = (3./ 4./ pi * Mvirphu / (overdensity * 1.89d-29 * 0.65 ** 2)) ** 0.333
        xmass = 0.5 * boxlen
        ymass = 0.5 * boxlen
        zmass = 0.5 * boxlen
        do i = 1, ncell
            rx = 0.0d0; ry = 0.0d0; rz = 0.0d0
            rx = x(i, 1) - xmass
#if NDIM > 1
            ry = x(i, 2) - ymass
#endif
#if NDIM > 2
            rz = x(i, 3) - zmass
#endif
            rr = sqrt(rx ** 2 + ry ** 2 + rz ** 2)
            gmass = 6.672d-8 * Mvirphu&
                &* (log(1.+ cnfw * rr / rvir) - cnfw * rr / rvir / (1.+ cnfw * rr / rvir))&
                &/ (log(1.+ cnfw) - cnfw / (1.+ cnfw))
            f(i, 1) = - gmass * rx / rr ** 3
#if NDIM > 1
            f(i, 2) = - gmass * ry / rr ** 3
#endif
#if NDIM > 2
            f(i, 3) = - gmass * rz / rr ** 3
#endif
        end do

    end if
end subroutine gravana
